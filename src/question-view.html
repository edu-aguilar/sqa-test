<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/app-route/app-route.html">

<link rel="import" href="styles/shared-styles.html">

<link rel="import" href="data-providers/quiz-status-data.html">

<link rel="import" href="components/question-tabs.html">
<link rel="import" href="components/question-container.html">
<link rel="import" href="components/gradient-progress-bar.html">
<link rel="import" href="components/progress-timer.html">

<dom-module id="question-view">
  <template>
    <style include="shared-styles">
      question-tabs {
        grid-area: tabs;
      }

      question-container {
        grid-area: question;
      }

      gradient-progress-bar {
        grid-area: progressbar;
      }

      :host {
        display: grid;
        grid-template-columns: 1fr;
        grid-template-rows: 32px 1fr 60px;
        grid-template-areas: "tabs" "question" "progressbar";
      }
    </style>

    <app-route route="{{route}}" pattern="/:id" data="{{routeData}}">
    </app-route>

    <quiz-status-data id="quizStatus" total-questions="[[quizData.questions.length]]" progress="{{quizProgress}}" answered-questions="{{answeredQuestions}}"
      answered-questions-count="{{answeredQuestionsCount}}">
    </quiz-status-data>

    <question-tabs questions="[[quizData.questions]]" answered-questions="[[answeredQuestions]]" selected="{{routeData.id}}">
    </question-tabs>

    <question-container quiz-data="[[quizData]]" question="[[question]]" selected-answer="{{selectedAnswer}}"></question-container>


    <gradient-progress-bar progress="[[quizProgress]]">
      <div slot="left">[[quizData.testName]]</div>
      <div slot="center">[[answeredQuestionsCount]] / [[quizData.questions.length]]</div>
      <div slot="right">
        <progress-timer id="progressTimer" time-passed="[[timePassed]]"></progress-timer>
      </div>
    </gradient-progress-bar>
  </template>

  <script>
    class QuestionView extends Polymer.Element {
      static get is() { return 'question-view'; }

      static get properties() {
        return {
          route: Object,
          quizData: Object
        };
      }

      ready() {
        super.ready();
        this.$.progressTimer.start();
        this.addEventListener('onPageQuestionChange', this._pageChange);
      }

      static get observers() {
        return [
          '_routeIdChanged(routeData.id)',
          '_setAnsweredQuestion(selectedAnswer)'
        ];
      }

      _setAnsweredQuestion(answerId) {
        if (answerId) {
          let questionId = this.routeData.id;
          this.$.quizStatus.setAnsweredQuestion(questionId, answerId);
          // check if finish button have to be enabled
          this.shadowRoot
          .querySelector('question-container')
          .shadowRoot.querySelector('quiz-paginator')
          .shadowRoot
          .querySelector('.finish')
          .disabled = Object.keys(this.answeredQuestions).length === this.quizData.questions.length  ? false : true;
        }
      }

      _routeIdChanged(id) {
        let question = this.quizData.questions.find((q) => {
          return Number(q.id) === Number(id);
        });

        this._setButtonDisabled(this.quizData.questions.findIndex(i => i.id == question.id));

        if (question) {
          this.set('question', question);
          this.selectedAnswer = this.answeredQuestions[question.id] ? this.answeredQuestions[question.id] : '';

        }
      }

      _pageChange(event) {

        let data = event.detail.operation;
        let index = this.quizData.questions.findIndex(i => i.id == this.question.id);

        switch (data) {
          case 'next':
            index++;
            break;
          case 'back':
            index--;
            break;
          case 'finish':
            var event = new CustomEvent('onRouteChange', { detail: { newRoute: 'result' }, composed: true });
            this.dispatchEvent(event);
            break;
          default:
            break;
        }  

        this.routeData.id =  this.quizData.questions[index].id;
        this.notifyPath('routeData.id');
             
      }


      _setButtonDisabled(index) {

        let quizPaginator = this.shadowRoot.querySelector('question-container')
                                .shadowRoot.querySelector('quiz-paginator')

        if (index === this.quizData.questions.length - 1) {
          quizPaginator.shadowRoot.querySelector('.next').disabled = true;
          quizPaginator.shadowRoot.querySelector('.back').disabled = false;
        } else if (index === 0) {
          quizPaginator.shadowRoot.querySelector('.next').disabled = false;
          quizPaginator.shadowRoot.querySelector('.back').disabled = true;
        } else {
          quizPaginator.shadowRoot.querySelector('.next').disabled = false;
          quizPaginator.shadowRoot.querySelector('.back').disabled = false;
        }
        
      }


    }

    window.customElements.define(QuestionView.is, QuestionView);

  </script>
</dom-module>