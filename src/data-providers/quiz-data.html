<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../components/quiz-local-storage.html">

<dom-module id="quiz-data">
  <template>
    <quiz-local-storage
      id="quizLocalStorage"
      storage-data="{{storageData}}">
    </quiz-local-storage>
  </template>
  <script>
    class QuizData extends Polymer.Element {
      static get is() {return 'quiz-data';}
      static get properties() {return {
        data: {
          type: Object,
          value: () => {},
          notify: true
        },
        quizType: {
          type: String
        },
        storageData: {
          type: Object,
          observer: '_loadData'
        }
      };}

      _loadData() {
        if (!this.quizType) return;
        if (this.storageData && this.storageData[this.quizType]) {
          this.loadFromStorage();
        } else {
          this.loadFromJson();
        }
      }

      loadFromStorage() {
        const quizData = this.storageData[this.quizType].quizData;
        if (!this.data && JSON.stringify(this.data) !== JSON.stringify(quizData)) {
          this.set('data', quizData);
        }
      }

      loadFromJson() {
        let url = `data/${this.quizType}.json`;
        fetch(url)
        .then((resp) => resp.json())
        .then((data) => {
          this.$.quizLocalStorage.updateStorage(this.quizType, 'quizData', data);
          this.set('data', data);
        })
        .catch(() => {this._notifyError();});
      }

      _notifyError() {
        let event = new CustomEvent(
          'onRouteChange',
          {
            detail: { newRoute: 'not-found' },
            composed: true
          }
        );
        this.dispatchEvent(event);
      }
    }

    customElements.define(QuizData.is, QuizData);
  </script>

</dom-module>
