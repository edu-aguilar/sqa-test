<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../components/quiz-local-storage.html">

<dom-module id="quiz-status-data">
  <template>
    <quiz-local-storage
      id="quizLocalStorage"
      storage-data="{{storageData}}">
    </quiz-local-storage>
  </template>
  <script>
  (function() {
    let quizStatusData = {
      answeredQuestions: {}
    };

    let subscribers = [];

    class QuizStatusData extends Polymer.Element {
      static get is() {return 'quiz-status-data';}

      static get properties() {
        return {
          totalQuestions: Number,
          answeredQuestions: {
            type: Object,
            notify: true,
            value: () => quizStatusData.answeredQuestions
          },
          quizType: {
            type: String,
            value: () => quizStatusData.quizType,
            observer: '_setQuizType'
          },
          progress: {
            type: Number,
            notify: true,
            computed: '_computeProgress(answeredQuestions.*, totalQuestions)'
          },
          timePassed: {
            type: Number,
            notify: true
          },
          answeredQuestionsCount: {
            type: Number,
            notify: true
          },
          storageData: {
            type: Object,
            observer: '_loadFromStorage'
          }
        };
      }

      constructor() {
        super();
        subscribers.push(this);
      }

      disconnectedCallback() {
        super.disconnectedCallback();
        subscribers.splice(subscribers.indexOf(this), 1);
      }

      updateTime(timePassed) {
        if (this.quizType && this.$.quizLocalStorage.storageData[this.quizType]) {
          this.$.quizLocalStorage.updateStorage(this.quizType, 'timePassed', timePassed);
        }
      }

      _setQuizType(quizType) {
        if (quizType) this.quizType = quizType;
      }

      _loadFromStorage(storageData) {
        if (storageData[this.quizType]) {
          this.timePassed = storageData[this.quizType].timePassed;
          this.answeredQuestions = storageData[this.quizType].answeredQuestions || {};
        }
      }
      setAnsweredQuestion(questionId, answerId) {
        if (!quizStatusData.answeredQuestions[questionId]) {
          quizStatusData.answeredQuestions[questionId] = '';
          this.__updateSubscribers(`answeredQuestions.${questionId}`);
        }
        quizStatusData.answeredQuestions[questionId] = answerId;
        this.$.quizLocalStorage.updateStorage(
          this.quizType,
          `answeredQuestions.${questionId}`,
          answerId
        );
        this.__updateSubscribers(`answeredQuestions.${questionId}`);
      }

      _computeProgress() {
        this.answeredQuestionsCount = Object.keys(this.answeredQuestions).length;
        return this.answeredQuestionsCount / this.totalQuestions * 100;
      }

      __updateSubscribers(path) {
        subscribers.forEach((subscriber) => {subscriber.notifyPath(path);});
      }
    }

    customElements.define(QuizStatusData.is, QuizStatusData);
  })();
  </script>

</dom-module>
