<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../components/quiz-local-storage.html">

<dom-module id="quiz-status-data">
  <template>
    <quiz-local-storage
      id="quizLocalStorage"
      storage-data="{{storageData}}">
    </quiz-local-storage>
  </template>
  <script>
  (function() {
    let quizStatusData = {
      answeredQuestions: {}
    };

    let subscribers = [];

    class QuizStatusData extends Polymer.Element {
      static get is() {return 'quiz-status-data';}

      static get properties() {
        return {
          totalQuestions: Number,
          answeredQuestions: {
            type: Object,
            notify: true,
            value: () => quizStatusData.answeredQuestions
          },
          profile: {
            type: String,
            value: () => quizStatusData.profile,
            observer: '_setProfile'
          },
          progress: {
            type: Number,
            notify: true,
            computed: '_computeProgress(answeredQuestions.*, totalQuestions)'
          },
          timePassed: {
            type: Number,
            notify: true
          },
          answeredQuestionsCount: {
            type: Number,
            notify: true
          },
          storageData: {
            type: Object,
            observer: '_loadFromStorage',
            notify: true
          }
        };
      }

      constructor() {
        super();
        subscribers.push(this);
      }

      disconnectedCallback() {
        super.disconnectedCallback();
        subscribers.splice(subscribers.indexOf(this), 1);
      }

      updateTime(timePassed) {
        this.$.quizLocalStorage.updateStorage('timePassed', timePassed);
      }

      setUserData(user) {
        this.$.quizLocalStorage.updateStorage('user', user);
        this.updateTime(0);
      }

      _setProfile(profile) {
        if (profile && profile.id) {
          this.profile = profile.id;
          this.$.quizLocalStorage.updateStorage('profile', this.profile);
        }
      }

      _loadFromStorage(storageData) {
        if (this.profile && storageData) {
          this.timePassed = storageData.timePassed;
          this.answeredQuestions = storageData.answeredQuestions || {};
        }
      }

      setAnsweredQuestion(questionId, answerId) {
        if (!quizStatusData.answeredQuestions[questionId]) {
          quizStatusData.answeredQuestions[questionId] = '';
          this.__updateSubscribers(`answeredQuestions.${questionId}`);
        }
        quizStatusData.answeredQuestions[questionId] = answerId;
        this.$.quizLocalStorage.updateStorage(`answeredQuestions`, quizStatusData.answeredQuestions);
        this.__updateSubscribers(`answeredQuestions.${questionId}`);
      }

      _computeProgress() {
        this.answeredQuestionsCount = Object.keys(this.answeredQuestions).length;
        return this.answeredQuestionsCount / this.totalQuestions * 100;
      }

      __updateSubscribers(path) {
        subscribers.forEach((subscriber) => {subscriber.notifyPath(path);});
      }

      clearLocalStorage() {
        this.$.quizLocalStorage.clearStorage();
      }
    }

    customElements.define(QuizStatusData.is, QuizStatusData);
  })();
  </script>

</dom-module>
