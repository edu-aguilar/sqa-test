<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../bower_components/i18n-msg/i18n-msg.html">

<link rel="import" href="data-providers/quiz-data.html">
<link rel="import" href="styles/shared-styles.html">

<link rel="lazy-import" href="views/landing-view.html">
<link rel="lazy-import" href="views/question-view.html">
<link rel="lazy-import" href="views/result-view.html">
<link rel="lazy-import" href="views/not-found-view.html">


<dom-module id="sopra-quiz-app">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
      }

      app-header {
        background-color: white;
        grid-area: header;
      }

      iron-pages {
        grid-area: pages;
        height: 100%;
      }

      app-header-layout {
        display: grid;
        grid-template-columns: 1fr;
        grid-template-rows: 64px 1fr;
        grid-template-areas:
        "header"
        "pages";
      }

      app-toolbar {
        justify-content: center;
      }

      app-toolbar .quiz-logo {
        height: var(--sopra-quiz-app-header, 64px);
      }
    </style>

    <app-location
        id="appLocation"
        route="{{route}}"
        url-space-regex="^[[rootPath]]">
    </app-location>

    <app-route
        id="appRouteProfile"
        route="{{route}}"
        pattern="[[rootPath]]:profile"
        data="{{routeData}}"
        tail="{{subroute}}">
    </app-route>

    <app-route
        id="appRoutePage"
        route="{{subroute}}"
        pattern="/:page"
        data="{{_subrouteData}}"
        tail="{{subrouteTail}}">
    </app-route>
    <quiz-local-storage
      id="quizLocalStorage"
      storage-data="{{_storageData}}">
    </quiz-local-storage>
    <quiz-data
      id="quizData"
      profile="[[routeData.profile]]"
      data="{{quizData}}">
    </quiz-data>

    <app-drawer-layout id="appDrawer" fullbleed>

      <app-header-layout has-scrolling-region>

        <app-header slot="header" condenses reveals effects="waterfall">
          <app-toolbar>
            <img class="quiz-logo" src="[[importPath]]../images/soprasteria-quiz.png" alt="sopra-quiz-logo">
          </app-toolbar>
        </app-header>

        <iron-pages
            selected="[[page]]"
            attr-for-selected="name"
            fallback-selection="view404"
            role="main">
          <landing-view name="landing" quiz-data="[[quizData]]"></landing-view>
          <question-view
            name="question"
            route="{{subrouteTail}}"
            quiz-data="[[quizData]]"
            profile="[[routeData.profile]]">
          </question-view>
          <result-view 
            name="result" 
            on-site="[[quizData.onSite]]" 
            result-message="[[quizData.resultMessage]]"
            profile="[[routeData.profile]]">
          </result-view>
          <not-found-view name="not-found"></not-found-view>
        </iron-pages>
      </app-header-layout>
    </app-drawer-layout>
  </template>

  <script>
    class SopraQuizApp extends Polymer.mixinBehaviors([this.i18nMsgBehavior], Polymer.Element) {
      static get is() {return 'sopra-quiz-app';}

      static get properties() {
        return {
          _subrouteData: Object,
          _storageData: Object,
          page: {
            type: String,
            reflectToAttribute: true,
            observer: '_pageChanged'
          },
          routeData: Object,
          subroute: Object,
          rootPath: String,
          language: {
            type: String,
            value: 'es'
          },
          importPath: String
        };
      }

      static get observers() {
        return [
          '_routePageChanged(_subrouteData.page)'
        ];
      }

      ready() {
        super.ready();

        // After overwriting the ready function, I18nMsg needs to be initialized again
        this.init(window.I18nMsg);
        this._initLanguage();

        // Language initialization event under the polyfill for browsers that don't support HTML imports
        this.addEventListener('HTMLImportsLoaded', this._initLanguage);

        this.addEventListener('onRouteChange', this._onRouteChange);
      }

      _routePageChanged(page) {
        if (!page) {
          this.set('route.path', `${this.rootPath}frontend`);
          this.set('subroute.path', 'landing');
          this.page = 'landing';
          return;
        }
        this.page = page;
      }

      _pageChanged(page) {
        // Load page import on demand. Show 404 page if fails
        var resolvedPageUrl = this.resolveUrl(`views/${page}-view.html`);
        Polymer.importHref(
            resolvedPageUrl,
            null,
            this._showPage404.bind(this),
            true);
      }

      _onRouteChange(e) {
        const newRoute = e.detail.newRoute;
        let path = newRoute === 'not-found'
          ? `${this.rootPath}test/${newRoute}`
          : `${this.rootPath}${this.routeData.profile}/${newRoute}`;

        this.set('route.path', path);
      }

      _initLanguage() {
        // Set current language
        window.I18nMsg.lang = this.language;
        // This is required due to the removal of Object.observe() - More info on i18n-msg docs
        window.Platform.performMicrotaskCheckpoint();
      }

      _showPage404() {
        this.page = 'not-found';
      }
    }

    window.customElements.define(SopraQuizApp.is, SopraQuizApp);
  </script>
</dom-module>
